<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>gemz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            text-align: center;
            overflow: hidden;
            background-color: green;
        }
    </style>

    <meta name="viewport" content="width=device-width, user-scalable=no" />
</head>

<body>
    <script type="module">
        import Background from './src/Background.js';
        import Floor from './src/Floor.js';
        import Player from './src/Player.js';
        import Controls from './src/Controls.js';

        const gemz = new PIXI.Application({
            width: window.innerWidth,
            height: window.innerHeight,
            antialias: true,
            transparent: false,
            resolution: 1,
            backgroundColor: 0x262d41,
            autoDensity: true
        });

        let type = "WebGL"

        if (!PIXI.utils.isWebGLSupported()) {
            type = "canvas"
        }

        document.body.appendChild(gemz.view);

        const floor = new Floor(new PIXI.Graphics());
        const player = new Player(window.innerWidth / 2, window.innerHeight - 200, 100, 100);
        const background = new Background();
        const controls = new Controls(player, floor);

        floor.draw();
        controls.listen();

        const bushTexture = PIXI.Texture.from('./assets/bush.png');
        const treeTexture = PIXI.Texture.from('./assets/tree.png');

        const objects = []

        window.setInterval(function () {
            let sprite = new PIXI.Sprite(bushTexture);
            sprite.zIndex = 1
            objects.push({
                x: window.innerWidth / 2,
                y: 0,
                height: 5,
                width: 5,
                sprite: sprite,
                direction: Math.floor(Math.random() * 2) + 1,
                xMovement: Math.floor(Math.random() * 3700) + 500,
                multiplier: 0,
                growBy: 0.4
            })
        }, 600);

        window.setInterval(function () {
            let sprite = new PIXI.Sprite(treeTexture);
            sprite.zIndex = 2
            objects.push({
                x: window.innerWidth / 2 - 50,
                y: -200,
                height: 10,
                width: 10,
                sprite: sprite,
                direction: Math.floor(Math.random() * 2) + 1,
                xMovement: Math.floor(Math.random() * 3700) + 500,
                multiplier: 0,
                growBy: 1
            })
        }, 2000);

        const ticker = gemz.ticker;
        
        ticker.add(delta => {
            objects.some((object, i) => {
                if(player.containsPoint(new PIXI.Point(object.x, object.y)) || object.sprite.containsPoint(new PIXI.Point(player.player.x, player.player.y))) {
                    player.player.visible = false
                    ticker.stop()
                }

                object.sprite.x = object.x
                object.sprite.y = object.y
                object.sprite.width = object.width
                object.sprite.height = object.height
                floor.graphics.addChild(object.sprite);

                object.y = object.y + 4 * object.multiplier;

                if(object.direction === 1){
                    object.x = object.x + (window.innerWidth / object.xMovement)  * object.multiplier
                }else{
                    object.x = object.x - (window.innerWidth / object.xMovement)  * object.multiplier
                }

                object.height = object.height + object.growBy;
                object.width = object.width + object.growBy;
                object.multiplier = object.multiplier + 0.01

                if(window.innerHeight < object.y) {
                    object.visible = false;
                    objects.splice(i, 1)
                }
            })
        });


        gemz.stage.addChild(background.background);
        gemz.stage.addChild(floor.graphics);
        gemz.stage.addChild(player.player);
    </script>
</body>

</html>